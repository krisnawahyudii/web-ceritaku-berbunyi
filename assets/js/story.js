const stories = {
  "kutukan-raja-mintim": {
    title: "Legenda Kutukan Raja Mintim",
    pages: [
      "Alkisah, dahulu di Pulau Mintin, daerah Kahayan Hilir terdapat sebuah kerajaan. Rajanya terkenal arif dan bijaksana. Di bawah pemerintahannya, kerajaan mencapai kejayaan dan kemakmuran. Rakyatnya hidup sejahtera dan bahagia. Pada suatu ketika, sang permaisuri meninggal dunia. Raja sangat terpukul dan bersedih hati. Segala upaya dilakukan untuk menghilangkan duka lara sang Raja, tetapi apa pun hiburan yang disuguhkan tidak membuat dirinya bahagia. Akhirnya, untuk menghibur hatinya yang sedang gundah gulana, sang Raja berniat hendak berlayar. Maka tugas pemerintahan diserahkan kepada kedua putra kembarnya, yaitu Naga dan Buaya. Sang raja menjelaskan segala sesuatunya yang berhubungan dengan tugas seorang pemimpin. Di hadapan raja, dengan sepenuh hati, mereka menerima tanggung jawab tersebut. Setelah raja berlayar, mereka berdua menduduki tahta kerajaan.",
      "Belum lama menjalankan amanat raja, timbul persoalan yang diakibatkan perbedaan watak keduanya. Si Naga senang menghambur-hamburkan harta, sedangkan si Buaya dikenal sebagai sosok yang pemurah, hemat, dan suka menolong. Melihat hal itu, si Buaya mencoba menasihati saudaranya. Agaknya, si Naga benar-benar berhati batu. Apa pun nasehat yang dikatakan saudara kembarnya tak membuatnya berubah. Adu mulut pun sering terjadi hingga berujung pada pertikaian. Pertengkaran dua saudara itu kian hari kian menjadi. Tidak hanya adu mulut dan adu fisik di antara mereka berdua, tetapi sudah melibatkan para prajurit kerajaan dan rakyat. Sebagian membela si Naga, sebagian lagi berada di belakang si Buaya. Akibat pertengkaran hebat telah menimbulkan banyak korban jiwa di kalangan istana dan rakyat umumnya.",
      `Apa yang dialami kerajaan terasa juga oleh Raja. Sementara dalam pelayarannya, sang Raja merasa ada yang tidak Beres. Maka, diperintahkannya nahkoda kapal berbalik menuju istana. Benar saja, rupanya perang saudara tengah berlangsung dengan sengitnya. Melihat keadaan tersebut, Raja benar-benar murka. Raja segera mengambil tindakan dan dengan lantang Raja berkata kepada Naga dan Buaya. "Kalian berdua telah merusak kepercayaan yang aku berikan. Banyak prajurit kerajaan yang tewas, karena kalian sibuk sendiri, dan rakyat tidak terurus. Oleh karena itu, aku jatuhkan hukuman kepada kalian berdua." Raja pun berseru dengan mantranya. "Buaya, jadilah engkau buaya dan hidup di air. Engkau diperbolehkan menetap di sini karena kesalahanmu sedikit. Kuperintahkan engkau untuk menjaga Pulau Mintin". Raja berseru dengan mantra kutukannya yang sakti.`,
      `"Sedangkan engkau, Naga, jadilah engkau seekor naga. Kamulah penyebab semua kekacauan ini dan pergilah ke Kapuas. Kamu bertugas melindungi sungai Kapuas agar tidak ditumbuhi Cendawan Bantilung." Lanjut sang Raja dengan penuh amarah. Baru saja kutukan itu terlontar, alam seolah-olah menunjukkan kemarahannya. Langit tiba-tiba menjadi gelap dan petir tidak henti-hentinya menggelegar. Kedua putra kembar raja berubah bentuk sesuai kutukan tersebut. Si Buaya menjelma menjadi buaya dan berdiam di pulau Mintin, sedangkan si Naga berubah menjadi naga dan hidup di sungai Kapuas.`,
      "Sepeninggal kedua anak kembarnya yang telah berubah wujud, Raja kembali membenahi kerajaannya. Raja juga minta maaf kepada rakyatnya atas kelakuan kedua anaknya. Kerajaan pun perlahan bangkit dan kembali hidup makmur dan sejahtera. [Eva De]",
    ],
    audio: "assets/mp3/kutukan-raja-mintim.mp3",
  },
  "putri-serindu": {
    title: "Legenda Putri Serindu",
    pages: [
      `Dahulu hiduplah seorang Raja Jungur dan permaisurinya yang memimpin Tanah Rejang. Mereka mempunyai seorang putri yang sangat cantik jelita bernama Putri Serindu. Sang Raja dan permaisuri menginginkan putrinya segera menikah, mereka sudah lama ingin mempunyai menantu dan segera menimang cucu. Namun sang Putri belum menginginkan menikah. la selalu menolak setiap pangeran yang datang melamarnya ke istana. Suatu hari permaisuri mendekati Putri Serindu dan kembali membujuknya, "Putriku, katakaniah pada Ibunda, pemuda yang bagaimanakah yang engkau tunggu, Nak?" tanya permaisuri sambil mengelus lembut rambut anaknya. Putri Serindu memeluk ibundanya, ia kemudian berkata, "Maafkan Ananda, Ibunda. Karena telah membuat Ibunda dan Ayahanda sedih dan bingung. Ananda hanya akan menikah dengan Raja Tidur,"`,
      `ucap Putri Serindu pelan tapi mantap dan yakin, "Mohon maaf Ibunda apabila laki-laki pilihan Ananda tidak berkenan di hati Ibunda dan Ayahanda," tambahnya Raja dan Permaisuri bertambah bingung mendengar permintaan putrinya. Kemana mereka harus mencari Raja Tidur itu. Akhirnya sang Raja mendapatkan ide untuk mengadakan sayembara, ia kemudian memanggil prajuritnya dan berkata, "Prajurit! Aku akan mengadakan sayembara. Siapa saja yang bisa tidur paling lama, dialah yang akan kunobatkan sebagai Raja Tidur dan akan kujadikan menantuku!" Keesokkan paginya, para prajurit kerajaan sudah menyebarkan pengumuman tentang sayembara itu di berbagai tempat, "PERHATIAN!" teriak prajurit, "Raja mengadakan sayembara untuk kalian semua kaum laki-laki! Barang siapa paling lama tidur akan dijadikan suami Putri Serindu!" jelas prajurit itu.`,
      `Akhirnya banyak orang berbondong-bondong mengikuti sayembara itu karena mereka anggap itu perlombaan sangat mudah. Di antara yang mengikuti sayembara itu ialah seorang pemuda desa yang tampan bernama Anak Lumang, la adalah pemuda yatim piatu. Setiap hari pekerjaannya membuat bubu yaitu tempat menangkap ikan dari bambu, kemudian dijualnya di pasar. Anak Lumang bingung mengikuti sayembara itu atau tidak. Sebab, jika ia ikut, ia tak bisa membuat bubu dan tak bisa makan hari itu. Akhirnya setelah berpikir, ia menemukan jalan keluarnya, ia akan membuat bubu dulu sebelum mengikuti sayembara itu. Sebelum berangkat ke istana, ia menyiapkan perlengkapan untuk membuat bubu, yaitu bambu yang sudah diraut seperti lidi dan diikat dengan tali rotan. Beronang berisi rotan, parang, pisau, tempurung dan alat-alat pelengkap membuat bubu lainnya.`,
      `Saat lomba diadakan, dan jam perlombaan dimulai, semua peserta mulai memejamkan matanya. Namun, Anak' Lumang malahan menyelesaikan pekerjaannya membuat bubu. Kali ini ia akan membuat bubu yang besar, indah dan rapi. Ketika semua peserta sudah benar-benar tidur dengan pulas, bubunya belum selesai juga. Baru ketika hari menjelang subuh, selesailah pekerjaan bubu itu dan digantungkan di dinding bagaikan hiasan. Indah sekali hasilnya. Setelah itu Anak Lumang tak langsung tidur, ia membereskan dulu semua sisa-sisa pekerjaannya itu dan membersihkan sampahnya terlebih dahulu. Setelah semua bersih, kantuknya sudah tak tertahankan lagi. Maka, tertidurlah ia dengan amat pulas. Setelah pagi datang, Putri Serindu berkeliling untuk menilai semua peserta satu-satu didampingi Baginda Raja, hulubalang dan para Menteri.`,
      `Putri Serindu melihat bubu dan terpesona dengan keindahan bubu yang digantung di dinding itu, ia juga sempat melihat beronang yang berisi perlengkapan membuat bubu. Putri Serindu mengira bahwa pemuda ini membuat bubu dulu sebelum tidur. Tentu saja la menjadi kelelahan dan bisa tidur nyenyak. Putri Serindu tersenyum, ia amat bahagia sudah menemukan calon suaminya yang tepat Putri Serindu mengumumkan siapakah yang menjadi pemenang sayembara itu. "Tuan-tuan semua, aku akan mengumumkan siapa pemenang sayembara ini. Namun sebelumnya ketahuilah, Raja Tidur yang kucari bukan pemuda yang benar-benar suka tidur, melainkan yang suka bekerja, rajin, dan tekun sehingga ketika tiba waktu tidur, ia bisa tidur dengan nyenyak sekali," ucap Putri Serindu,`,
      `"Pemenang sayembara ini bernama Anak Lumang!" jelas sang Putri yang tersenyum ke arah Anak Lumang. Akhirnya Putri Serindu menemukan tambatan hatinya, Baginda Raja Jungur dan permaisurinya sangat gembira. Diadakanlah pesta pernikahan yang megah dan meriah yang dilangsungkan selama tujuh hari tujuh malam dan mereka hidup bahagia selamanya. [Eva De]`,
    ],
    audio: "assets/mp3/Asal-Usul.mp3",
  },
  "bujang-awang-tabuang": {
    title: "Legenda Bujang Awang Tabuang",
    pages: [
      "Di sebuah desa di Bengkulu, hidup seorang pemuda bernama Awang Tabuang yang dikenal tampan dan kuat. Ia sering membantu penduduk desa tanpa pamrih.",
      "Suatu hari, Awang Tabuang pergi merantau untuk mencari pengalaman. Namun, ia tidak pernah kembali. Penduduk desa percaya ia telah berubah menjadi batu karena melanggar sumpah leluhurnya.",
      "Legenda ini dipercaya sebagai pengingat bagi generasi muda agar selalu menjaga janji dan menghormati adat istiadat.",
    ],
    audio: "assets/mp3/Asal-Usul.mp3",
  },
  "putri-salju": {
    title: "Putri Salju",
    pages: [
      "Di suatu kerajaan yang jauh, hiduplah seorang ratu yang memiliki cermin ajaib. Suatu hari, ratu melahirkan seorang putri yang sangat cantik dengan kulit seputih salju, rambut hitam legam, dan bibir merah seperti darah. Ia diberi nama Putri Salju.",
      "Seiring berjalannya waktu, Putri Salju tumbuh menjadi gadis yang sangat cantik. Ratu yang sombong menjadi cemburu karena kecantikannya tersaingi. Ia memerintahkan seorang pemburu untuk membawa Putri Salju ke hutan dan menyingkirkannya.",
      "Putri Salju berhasil kabur ke dalam hutan yang lebat. Di sana, ia menemukan sebuah rumah kecil yang dihuni oleh tujuh kurcaci yang baik hati. Mereka menerima Putri Salju dengan tangan terbuka dan hidup bersama dengan bahagia.",
    ],
    audio: "assets/mp3/Asal-Usul.mp3",
  },
}

const SUPABASE_URL = "https://blxsatvfxwsxvipitccq.supabase.co"
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJseHNhdHZmeHdzeHZpcGl0Y2NxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzMjk4MTMsImV4cCI6MjA2MzkwNTgxM30.G7mr8fV4gmQ9bvsepW_rjvk6SHPphJ-Ma-e46rjw6E0"
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// UI functions
function showError(message) {
  const errorToast = document.getElementById("error-toast")
  const errorMessage = document.getElementById("error-message")
  errorMessage.textContent = message
  errorToast.classList.add("show")
  setTimeout(() => {
    errorToast.classList.remove("show")
  }, 5000)
}
function showSuccess(message) {
  const successToast = document.getElementById("success-toast")
  const successMessage = document.getElementById("success-message")
  successMessage.textContent = message
  successToast.classList.add("show")
  setTimeout(() => {
    successToast.classList.remove("show")
  }, 3000)
}

function getQueryParam(name) {
  const url = new URL(window.location.href)
  return url.searchParams.get(name)
}

// Supabase view count
async function getViewCount(storySlug) {
  try {
    const { data, error } = await supabase
      .from("story_views")
      .select("view_count")
      .eq("story_slug", storySlug)
      .single()
    if (error) {
      if (error.code === "PGRST116") return await createViewRecord(storySlug)
      throw error
    }
    return data.view_count || 0
  } catch (error) {
    showError("Gagal memuat data tampilan cerita")
    return 0
  }
}
async function createViewRecord(storySlug) {
  try {
    const { data, error } = await supabase
      .from("story_views")
      .insert([{ story_slug: storySlug, view_count: 0 }])
      .select()
      .single()
    if (error) throw error
    return 0
  } catch (error) {
    showError("Gagal membuat record baru")
    return 0
  }
}
async function incrementViewCount(storySlug) {
  try {
    const currentCount = await getViewCount(storySlug)
    const newCount = currentCount + 1
    const { error } = await supabase
      .from("story_views")
      .upsert([{ story_slug: storySlug, view_count: newCount }], {
        onConflict: "story_slug",
        ignoreDuplicates: false,
      })
      .select()
      .single()
    if (error) throw error
    return newCount
  } catch (error) {
    showError("Gagal memperbarui jumlah tampilan")
    return 0
  }
}

let currentStory = null
let currentPage = 0
let isPlaying = false

async function loadStoryPage() {
  const slug = getQueryParam("slug")
  if (!slug || !stories[slug]) {
    showError("Cerita tidak ditemukan")
    document.getElementById("story-section").classList.add("hidden")
    document.getElementById("loading-indicator").style.display = "none"
    return
  }
  document.getElementById("loading-indicator").style.display = "block"
  currentStory = stories[slug]
  currentPage = 0
  // Increment view count
  const viewCount = await incrementViewCount(slug)
  // Set content
  document.getElementById("story-title").innerText = currentStory.title
  document.getElementById("view-count").innerText = viewCount
  updatePageContent()
  // Setup audio
  const audio = document.getElementById("story-audio")
  audio.src = currentStory.audio
  audio.load()
  audio
    .play()
    .then(() => {
      isPlaying = true
      document.getElementById("audio-btn").innerHTML =
        '<span class="mr-2">⏸️</span> Audio'
    })
    .catch((err) => {
      // Gagal autoplay: browser policy
      isPlaying = false
      // Tampilkan tombol Audio sebagai 'Play' dan beri animasi agar user sadar harus klik
      const audioBtn = document.getElementById("audio-btn")
      if (audioBtn) {
        audioBtn.classList.add("animate-bounce", "bg-red-400")
        audioBtn.title = "Klik untuk memulai audio"
        audioBtn.innerHTML = '<span class="mr-2">▶️</span> Audio'
      }
      // TRICK: Play audio saat user klik di mana saja di halaman
      const tryPlay = () => {
        audio
          .play()
          .then(() => {
            isPlaying = true
            if (audioBtn) {
              audioBtn.classList.remove("animate-bounce", "bg-red-400")
              audioBtn.innerHTML = '<span class="mr-2">⏸️</span> Audio'
              audioBtn.title = ""
            }
            document.removeEventListener("click", tryPlay)
          })
          .catch(() => {})
      }
      document.addEventListener("click", tryPlay)
    })
  document.getElementById("loading-indicator").style.display = "none"
  document.getElementById("story-section").classList.remove("hidden")
}

function updatePageContent() {
  if (!currentStory) return
  const pageText = currentStory.pages[currentPage]
  const total = currentStory.pages.length
  document.getElementById("story-content").innerHTML = pageText
  document.getElementById("page-indicator").innerHTML = `Halaman ${
    currentPage + 1
  } dari ${total}`
  // Update button states
  document.getElementById("prev-btn").disabled = currentPage <= 0
  document.getElementById("prev-btn").style.opacity =
    currentPage <= 0 ? "0.5" : "1"
  document.getElementById("next-btn").disabled = currentPage >= total - 1
  document.getElementById("next-btn").style.opacity =
    currentPage >= total - 1 ? "0.5" : "1"
}

function nextPage() {
  if (!currentStory || currentPage >= currentStory.pages.length - 1) return
  currentPage++
  updatePageContent()
}
function prevPage() {
  if (!currentStory || currentPage <= 0) return
  currentPage--
  updatePageContent()
}
function toggleAudio() {
  try {
    const audio = document.getElementById("story-audio")
    const audioBtn = document.getElementById("audio-btn")
    if (isPlaying) {
      audio.pause()
      audioBtn.innerHTML = '<span class="mr-2">▶️</span> Audio'
    } else {
      audio
        .play()
        .then(() => {
          audioBtn.innerHTML = '<span class="mr-2">⏸️</span> Audio'
        })
        .catch(() => {
          showError("Gagal memutar audio. Pastikan file audio tersedia.")
        })
    }
    isPlaying = !isPlaying
  } catch (error) {
    showError("Terjadi kesalahan pada audio player")
  }
}
document.getElementById("story-audio").addEventListener("ended", function () {
  isPlaying = false
  document.getElementById("audio-btn").innerHTML =
    '<span class="mr-2">▶️</span> Audio'
})
document.getElementById("story-audio").addEventListener("error", function (e) {
  showError("File audio tidak dapat dimuat")
})

document.addEventListener("DOMContentLoaded", function () {
  loadStoryPage()
})
window.addEventListener("online", function () {
  showSuccess("Koneksi internet tersambung kembali")
  loadStoryPage()
})
window.addEventListener("offline", function () {
  showError(
    "Koneksi internet terputus. Beberapa fitur mungkin tidak berfungsi."
  )
})
function goToIndexWithIndo() {
  // Simpan preferensi bahasa ke localStorage
  localStorage.setItem("preferredLanguage", "id")
  // Arahkan ke index
  window.location.href = "index.html"
}
